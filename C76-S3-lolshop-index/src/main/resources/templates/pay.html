<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>LOL周边商城</title>
<link rel="stylesheet" href="css/header.css" />
<link href="css/common.css" rel="stylesheet" type="text/css">
<link href="css/cart.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript">
		var xmlhttp;
		var r=false;
		// ajax 验证用户名是否存在
		try {
			xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
			try {
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			} catch (e) {
				try {
					xmlhttp = new XMLHttpRequest();
				} catch (e) {
				}
			}
		}
		function change() {
			var name = document.getElementById("name").value;
			var phone = document.getElementById("phone").value;
			var addr = document.getElementById("addr").value;
			
			
				if (xmlhttp != null ) {
					// 定义请求地址
					var url = "doAddOrder.s?name=" + name
							+ "&phone=" + phone + "&addr=" + addr;
					// 以 POST 方式 开启连接
					// POST 请求 更安全（编码）  提交的数据大小没有限制
					xmlhttp.open("POST", url, true);

					// 设置回调函数   // 当收到服务器的响应时，会触发该函数（回调函数）
					// 每次的状态改变都会调用该方法
					xmlhttp.onreadystatechange = function() {
						if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
							var json = xmlhttp.responseText.replace(/\s/gi, "");
							eval("var result = " + json);
							console.info(result);
							
							if(result.code == 1){
								//成功   跳转到登录页面
								location.href = "myinfo.html";
							}else{
								//失败   提示错误信息
								alert(result.msg);
							}
						}
					};
					// 发送请求
					xmlhttp.send(null);
					
			} else {
				alert("不能创建XMLHttpRequest对象实例")
			}
			
			

		}
	
		function check(){
			var valid = true;
			$("#userInfoForm input[name]").each(function(){
				if($(this).next().text()!=""){
					alert($(this).next().text());
					valid = false;
					return false;
				}
			});
			if(valid){
				//$("#userInfoForm").submit();
				dir_confirm();
				if(r==true){
					change();
				}
			}
		}
		function dir_confirm(){
			var choose = confirm("确认修改?");
			if(choose==true){
				r = true;
			}else{
				r = false;
			}
		}
	</script>
</head>
<body>
<%@ include file="/common/header.html" %>	

<div class="container cart">

		<div class="span24">
		
			<div class="step step1">
				<ul>
					<%
						String sql1 = "select * from orders where uid=?";
					    
						Map<String,Object> map = (Map<String,Object>)session.getAttribute("loginedUser");
						Object uid = map.get("uid");
						
						List<Map<String,Object>> list3 = DBHelper.selectList(sql1, uid);
						for(Map<String,Object> n : list3) {
							pageContext.setAttribute("o", n);
					} %>
					<li  class="current"></li>
					<li  >生成订单成功</li>
					<li  >订单号:${o.oid}</li>
					
				</ul>
			</div>
		
				<table>
					<tbody>
					<tr>
						<th>图片</th>
						<th>商品</th>
						<th>价格</th>
						<th>数量</th>
						<th>小计</th>
					</tr>
					<%
						Map<String,Object> user = (Map<String,Object>)session.getAttribute("loginedUser");
						String sql = "select sum(subTotal) from cartitem where uid=?";
			 			Object sum = DBHelper.selectValue(sql, uid);
			 			session.setAttribute("sum", sum);
					 	
					 	sql  = "select * from cartitem where uid=?";
					 	List<Map<String,Object>> list = DBHelper.selectList(sql, uid);
					 	for(Map<String,Object> m :list){
					 		pageContext.setAttribute("c", m);
					%> 
					<%
						Object pid = m.get("pid");
						String sql2 = "select * from product where pid=?";
						List<Map<String,Object>> list2 = DBHelper.selectList(sql2, pid);
						for(Map<String,Object> n :list2){
							pageContext.setAttribute("p", n);
					%>
						<tr>
							<td width="60">
								<img src="${p.image}"/>
							</td>
							<td>
								<a target="_blank">${p.pname }</a>
							</td>
							<td>
								${p.price }
							</td>
							<td class="quantity" width="60">
								${c.count}						
							</td>
							<td width="140">
								<span class="subtotal">￥${c.subTotal}</span>
							</td>
						</tr>
						<%} %>
					<%} %>
				</tbody>
			</table>
				<dl id="giftItems" class="hidden" style="display: none;">
				</dl>
				<div class="total">
					<em id="promotion"></em>
					商品金额: <strong id="effectivePrice">￥ <%=sum%> 元</strong>
				</div>
				<div class="title">
					<%if(request.getAttribute("msg")!=null){ %>
						<font color="red"><%=request.getAttribute("msg")%></font>
					<%}%>
				</div>
			<form id="orderForm" action="doAddOrder.s" method="post">
				<div class="span24">
					
					<table>
						<tbody>
							<tr>
								<th>
									收货地址:
								</th>
								<td>
									<input id="addr" name="addr" class="text" /><span></span>
								</td>
							</tr>
							<tr>
								<th>
									收货人:
								</th>
								<td>
									<input id="name" name="name" class="text" /><span></span>
								</td>
							</tr>
							<tr>
								<th>
									收货号码:
								</th>
								<td>
									<input id="phone"  name="phone" class="text" /><span></span>
								</td>
							</tr>
							
						</tbody>
					</table>
						<hr />
						<p>
							选择支付方式：<br/>
							<input type="radio" name="pd_FrpId" value="ICBC-NET-B2C" checked="checked"/>微信支付
							<img src="bank_img/weixin.png" style="width:200px;height:250px;"/>
							<input type="radio" name="pd_FrpId" value="BOC-NET-B2C"/>支付宝支付
							<img src="bank_img/zhifubao.png" style="width:200px;height:250px;"/>
						</p>
						<hr />
						<p style="text-align:right;">
						<input type="submit" value="确认订单" style="width:150px;height:50px;">
					</p>
				</div>
			</form>
		</div>
		
	</div>
	<%@ include file="/common/footer.html" %>
</body>
</html>